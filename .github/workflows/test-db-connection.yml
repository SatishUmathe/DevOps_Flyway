name: Test Database Connection (.NET Framework Console App)

on:
  workflow_dispatch:

jobs:
  test-db:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore Packages
        run: nuget restore ./DevOps_FlyWay.sln

      - name: Build Project
        run: msbuild ./DevOps_FlyWay/DevOps_FlyWay.csproj /p:Configuration=Release
     

      # ✅ Create Test DB
      - name: Create Test Database
        run: |
          sqlcmd -S localhost,1433 -U sa -P "yourStrong(!)Password" -Q "IF NOT EXISTS(SELECT * FROM sys.databases WHERE name='Test') CREATE DATABASE Test;"

      # ✅ (Optional) Test SQL connection
      - name: Test SQL Service
        run: sqlcmd -S localhost,1433 -U sa -P "yourStrong(!)Password" -Q "SELECT DB_NAME(); SELECT @@VERSION;"

      # ✅ Run Your App using CI connection string override
      - name: Run App
        working-directory: ./DevOps_FlyWay/bin/Release
        env:
          DB_CONNECTION_STRING: ${{ secrets.DB_CONNECTION_STRING }}
        run: ./DevOps_FlyWay.exe
